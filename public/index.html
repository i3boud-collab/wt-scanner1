<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#03060f">
<title>WT Scanner</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&family=Oxanium:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#03060f;--s1:#070e1d;--s2:#0b1730;--s3:#112040;--s4:#1a3060;
  --border:rgba(255,255,255,.055);--border2:rgba(255,255,255,.1);
  --buy:#00f5aa;--buy3:rgba(0,245,170,.06);
  --sell:#ff2d55;--sell3:rgba(255,45,85,.06);
  --blue:#38bdf8;--gold:#fbbf24;--purple:#a78bfa;--orange:#fb923c;
  --txt:#dde4f0;--muted:#4a5a7a;
  --mono:'Oxanium',monospace;--sans:'Tajawal',sans-serif;
  --sat:env(safe-area-inset-top,0px);--sab:env(safe-area-inset-bottom,0px);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{overflow-x:hidden}
body{
  background:var(--bg);color:var(--txt);font-family:var(--sans);min-height:100vh;
  background-image:
    radial-gradient(ellipse 80% 40% at 50% -10%,rgba(56,189,248,.07) 0%,transparent 70%),
    radial-gradient(ellipse 60% 30% at 80% 110%,rgba(0,245,170,.05) 0%,transparent 70%);
  background-attachment:fixed;
}
body::before{
  content:'';position:fixed;inset:0;
  background-image:linear-gradient(rgba(56,189,248,.018) 1px,transparent 1px),
    linear-gradient(90deg,rgba(56,189,248,.018) 1px,transparent 1px);
  background-size:48px 48px;pointer-events:none;z-index:0;
}

/* â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header{
  position:sticky;top:0;z-index:200;
  padding:calc(10px + var(--sat)) 16px 10px;
  background:rgba(3,6,15,.92);backdrop-filter:blur(30px);
  border-bottom:1px solid var(--border2);
}
.hd{display:flex;align-items:center;justify-content:space-between;gap:8px}
.logo{display:flex;align-items:center;gap:11px}
.logo-ring{
  width:40px;height:40px;flex-shrink:0;border-radius:12px;
  background:conic-gradient(from 0deg,var(--buy),var(--blue),var(--purple),var(--buy));
  display:flex;align-items:center;justify-content:center;
  animation:hue 10s linear infinite;font-size:20px;
}
@keyframes hue{to{filter:hue-rotate(360deg)}}
.logo-text{font-family:var(--mono);font-size:18px;font-weight:800;color:#fff}
.logo-sub{font-size:9px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-top:1px}
.hd-right{display:flex;align-items:center;gap:8px}
.live-chip{display:flex;align-items:center;gap:5px;padding:5px 11px;border-radius:20px;background:rgba(0,245,170,.06);border:1px solid rgba(0,245,170,.18);font-family:var(--mono);font-size:10px;color:var(--buy);}
.live-dot{width:5px;height:5px;border-radius:50%;background:var(--buy);animation:pulse 1.6s ease infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.mkt{font-family:var(--mono);font-size:10px;padding:4px 9px;border-radius:6px;background:var(--s2);border:1px solid var(--border);color:var(--muted);}
.mkt.open{color:#4ade80;border-color:rgba(74,222,128,.2);background:rgba(74,222,128,.06)}
.mkt.closed{color:var(--sell);border-color:rgba(255,45,85,.2);background:rgba(255,45,85,.06)}

/* INFO BAR */
.info-bar{
  background:rgba(7,14,29,.9);border-bottom:1px solid var(--border);
  padding:7px 16px;display:flex;align-items:center;justify-content:space-between;
  font-size:11px;color:var(--muted);font-family:var(--mono);
}
.ib-u{color:var(--txt)}
.scanning{display:none;align-items:center;gap:5px;color:var(--gold);font-size:11px}
.scanning.on{display:flex}
.spin{animation:rot .7s linear infinite;display:inline-block}
@keyframes rot{to{transform:rotate(360deg)}}

/* â•â•â• STRATEGY TABS (Ø±Ø¦ÙŠØ³ÙŠØ©) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.strat-tabs{
  display:flex;background:var(--bg);
  border-bottom:2px solid var(--border2);
  position:relative;z-index:1;
}
.strat-tab{
  flex:1;padding:15px 8px;text-align:center;cursor:pointer;
  font-family:var(--mono);font-size:12px;font-weight:700;
  color:var(--muted);border-bottom:3px solid transparent;
  margin-bottom:-2px;transition:all .2s;
}
.strat-tab:hover{color:var(--txt)}
.strat-tab.s-wt.active{color:var(--buy);border-bottom-color:var(--buy);background:rgba(0,245,170,.04)}
.strat-tab.s-bo.active{color:var(--orange);border-bottom-color:var(--orange);background:rgba(251,146,60,.04)}
.strat-icon{font-size:18px;display:block;margin-bottom:3px}
.strat-name{font-size:11px}
.strat-desc{font-size:9px;color:var(--muted);margin-top:2px;letter-spacing:.3px}

/* â•â•â• WAVETREND TIMEFRAME TABS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tf-wrap{display:none}
.tf-wrap.active{display:block}
.tf-tabs{
  display:flex;background:var(--s1);border-bottom:1px solid var(--border2);
}
.tf-tab{
  flex:1;padding:12px 8px;text-align:center;cursor:pointer;
  font-family:var(--mono);font-size:13px;font-weight:700;
  color:var(--muted);border-bottom:2px solid transparent;transition:all .2s;
}
.tf-tab.t15.active{color:var(--purple);border-bottom-color:var(--purple)}
.tf-tab.t1h.active{color:var(--buy);border-bottom-color:var(--buy)}
.tf-tab.t4h.active{color:var(--gold);border-bottom-color:var(--gold)}
.tf-badge{display:inline-flex;align-items:center;justify-content:center;background:var(--s3);border-radius:5px;font-size:9px;padding:1px 5px;margin-left:4px;}

/* â•â•â• STATS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stats{display:grid;grid-template-columns:repeat(4,1fr);background:var(--s1);border-bottom:1px solid var(--border);}
.sc{padding:11px 8px;text-align:center;border-left:1px solid var(--border);position:relative;overflow:hidden;}
.sc:last-child{border-left:none}
.sc::after{content:'';position:absolute;bottom:0;left:15%;right:15%;height:1.5px;border-radius:1px;}
.sc.g::after{background:linear-gradient(90deg,transparent,var(--buy),transparent)}
.sc.r::after{background:linear-gradient(90deg,transparent,var(--sell),transparent)}
.sc.y::after{background:linear-gradient(90deg,transparent,var(--gold),transparent)}
.sc.b::after{background:linear-gradient(90deg,transparent,var(--blue),transparent)}
.sc.o::after{background:linear-gradient(90deg,transparent,var(--orange),transparent)}
.sn{font-family:var(--mono);font-size:20px;font-weight:800;line-height:1}
.sc.g .sn{color:var(--buy)}.sc.r .sn{color:var(--sell)}.sc.y .sn{color:var(--gold)}.sc.b .sn{color:var(--blue)}.sc.o .sn{color:var(--orange)}
.sl{font-size:8px;color:var(--muted);margin-top:3px;letter-spacing:.5px;text-transform:uppercase}

/* â•â•â• FILTERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.filters{display:flex;gap:6px;overflow-x:auto;padding:10px 14px;background:var(--s1);border-bottom:1px solid var(--border);scrollbar-width:none;}
.filters::-webkit-scrollbar{display:none}
.f{flex-shrink:0;font-family:var(--sans);font-size:12px;font-weight:500;padding:6px 14px;border-radius:9px;cursor:pointer;background:var(--s2);border:1px solid var(--border2);color:var(--muted);transition:all .18s;white-space:nowrap;}
.f.on{background:var(--s3);color:var(--txt);border-color:var(--blue)}
.f.on-buy{background:var(--buy3);color:var(--buy);border-color:rgba(0,245,170,.3)}
.f.on-sell{background:var(--sell3);color:var(--sell);border-color:rgba(255,45,85,.3)}

/* â•â•â• CARDS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cards{padding:12px 12px calc(76px + var(--sab));display:flex;flex-direction:column;gap:9px;position:relative;z-index:1;}
@media(min-width:580px){.cards{display:grid;grid-template-columns:repeat(2,1fr)}}
@media(min-width:960px){.cards{grid-template-columns:repeat(3,1fr)}}

/* WT card */
.card{border-radius:14px;border:1px solid var(--border);background:var(--s1);overflow:hidden;transition:transform .12s;animation:rise .3s ease both;}
@keyframes rise{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.card:active{transform:scale(.97)}
.card.buy{border-top:2px solid var(--buy)}.card.sell{border-top:2px solid var(--sell)}
.ch{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;padding:13px 14px 10px;}
.ch-left{display:flex;align-items:center;gap:10px}
.arr{width:40px;height:40px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:22px;font-family:var(--mono);font-weight:800;flex-shrink:0;}
.card.buy  .arr{background:rgba(0,245,170,.1);color:var(--buy)}
.card.sell .arr{background:rgba(255,45,85,.1);color:var(--sell)}
.sym-row{display:flex;align-items:center;gap:7px}
.sym{font-family:var(--mono);font-size:19px;font-weight:800}
.card.buy  .sym{color:var(--buy)}.card.sell .sym{color:var(--sell)}
.new-tag{background:var(--sell);color:#fff;font-size:7px;font-family:var(--mono);font-weight:800;padding:2px 5px;border-radius:4px;animation:pulse 1s infinite;}
.ch-date{font-size:10px;color:var(--muted);font-family:var(--mono);margin-top:2px}
.ch-right{text-align:left;flex-shrink:0}
.ch-price{font-family:var(--mono);font-size:21px;font-weight:800;color:var(--txt);line-height:1}
.ch-lbl{font-size:8px;color:var(--muted);text-align:center;margin-top:2px}
.pills{display:flex;flex-wrap:wrap;gap:5px;padding:0 14px 12px;}
.p{display:inline-flex;align-items:center;gap:3px;padding:3px 9px;border-radius:7px;font-size:10px;font-family:var(--mono);font-weight:700;border:1px solid;}
.p-gb{background:rgba(0,245,170,.1);color:var(--buy);border-color:rgba(0,245,170,.25)}
.p-gs{background:rgba(255,45,85,.1);color:var(--sell);border-color:rgba(255,45,85,.25)}
.p-gr{background:rgba(74,222,128,.08);color:#4ade80;border-color:rgba(74,222,128,.2)}
.p-gy{background:rgba(255,255,255,.03);color:var(--muted);border-color:var(--border)}
.p-go{background:rgba(251,191,36,.08);color:var(--gold);border-color:rgba(251,191,36,.2)}
.p-gp{background:rgba(167,139,250,.08);color:var(--purple);border-color:rgba(167,139,250,.2)}
.rsi-m{display:flex;align-items:center;gap:5px}
.rsi-t{width:40px;height:3px;background:var(--s3);border-radius:2px;overflow:hidden}
.rsi-f{height:100%;border-radius:2px}
.cf{display:flex;border-top:1px solid var(--border);}
.cf-i{flex:1;padding:9px 8px;text-align:center;border-left:1px solid var(--border);}
.cf-i:last-child{border-left:none}
.cf-v{font-family:var(--mono);font-size:12px;font-weight:700}
.cf-l{font-size:8px;color:var(--muted);margin-top:2px;text-transform:uppercase;letter-spacing:.4px}

/* â•â•â• BREAKOUT CARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bo-card{
  border-radius:14px;border:1px solid var(--border);background:var(--s1);
  overflow:hidden;animation:rise .3s ease both;transition:transform .12s;
}
.bo-card:active{transform:scale(.97)}
.bo-card.buy{border-top:2px solid var(--buy)}
.bo-card.sell{border-top:2px solid var(--sell)}

.bo-head{padding:13px 14px 11px;display:flex;justify-content:space-between;align-items:flex-start}
.bo-left{display:flex;gap:10px;align-items:center}
.bo-icon{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.bo-card.buy  .bo-icon{background:rgba(0,245,170,.1)}
.bo-card.sell .bo-icon{background:rgba(255,45,85,.1)}
.bo-sym{font-family:var(--mono);font-size:20px;font-weight:800}
.bo-card.buy  .bo-sym{color:var(--buy)}.bo-card.sell .bo-sym{color:var(--sell)}
.bo-type{font-size:10px;color:var(--muted);font-family:var(--mono);margin-top:2px}
.bo-right{text-align:left}
.conf-ring{position:relative;width:52px;height:52px;}
.conf-ring svg{transform:rotate(-90deg)}
.conf-val{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:13px;font-weight:800;}

/* levels grid */
.bo-levels{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border);border-top:1px solid var(--border);}
.bo-lv{background:var(--s1);padding:10px 8px;text-align:center;}
.bo-lv-val{font-family:var(--mono);font-size:13px;font-weight:700}
.bo-lv-lbl{font-size:8px;color:var(--muted);margin-top:2px;text-transform:uppercase;letter-spacing:.5px}
.entry-v{color:var(--txt)}
.tp-v{color:var(--buy)}
.sl-v{color:var(--sell)}

/* ema row */
.bo-ema{display:flex;gap:1px;background:var(--border);border-top:1px solid var(--border);}
.bo-ema-i{flex:1;background:var(--s1);padding:8px;text-align:center}
.bo-ema-v{font-family:var(--mono);font-size:11px;font-weight:700;color:var(--blue)}
.bo-ema-l{font-size:8px;color:var(--muted);margin-top:1px}
.bo-tags{display:flex;flex-wrap:wrap;gap:5px;padding:10px 14px 12px;}

/* â•â•â• EMPTY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 20px;gap:14px;color:var(--muted);text-align:center;}
.e-icon{font-size:52px;opacity:.25;animation:float 3s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.e-title{font-size:17px;font-weight:700;color:var(--txt)}
.e-sub{font-size:12px;line-height:1.7;max-width:260px}

/* â•â•â• BOTTOM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bot{position:fixed;bottom:0;left:0;right:0;z-index:200;padding:8px 14px calc(8px + var(--sab));background:rgba(3,6,15,.93);backdrop-filter:blur(30px);border-top:1px solid var(--border2);display:flex;align-items:center;gap:8px;}
.search{flex:1;background:var(--s2);border:1px solid var(--border2);border-radius:11px;padding:10px 14px;color:var(--txt);font-family:var(--mono);font-size:13px;outline:none;direction:ltr;transition:border-color .2s;}
.search:focus{border-color:var(--blue)}
.search::placeholder{color:var(--muted);font-size:11px}
.icon-btn{width:42px;height:42px;flex-shrink:0;border-radius:11px;background:var(--s2);border:1px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer;transition:all .15s;}
.icon-btn:active{transform:scale(.9)}
.icon-btn.spinning{animation:rot .6s linear infinite}

/* TOAST */
.toast{position:fixed;top:calc(70px + var(--sat));left:50%;transform:translateX(-50%) translateY(-20px);background:var(--s2);border:1px solid var(--border2);border-radius:12px;padding:11px 20px;font-size:12px;color:var(--txt);box-shadow:0 8px 30px rgba(0,0,0,.4);opacity:0;transition:all .3s;z-index:300;white-space:nowrap;pointer-events:none;max-width:90vw;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="hd">
    <div class="logo">
      <div class="logo-ring">ğŸ“¡</div>
      <div>
        <div class="logo-text">SIGNAL SCANNER</div>
        <div class="logo-sub">Multi-Strategy Â· Live</div>
      </div>
    </div>
    <div class="hd-right">
      <div class="mkt" id="mktState">â€”</div>
      <div class="live-chip"><div class="live-dot"></div>LIVE</div>
    </div>
  </div>
</header>

<!-- INFO BAR -->
<div class="info-bar">
  <div style="display:flex;align-items:center;gap:6px">
    <span>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</span>
    <span class="ib-u" id="ibUpdate">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
  </div>
  <div class="scanning" id="scanWrap"><span class="spin">âŸ³</span><span>ÙŠØ¬Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­</span></div>
</div>

<!-- STRATEGY TABS -->
<div class="strat-tabs">
  <div class="strat-tab s-wt active" id="stab-wt" onclick="setStrat('wt')">
    <span class="strat-icon">ğŸŒŠ</span>
    <span class="strat-name">WaveTrend</span>
    <div class="strat-desc">WT Â· RSI Â· Volume</div>
  </div>
  <div class="strat-tab s-bo" id="stab-bo" onclick="setStrat('bo')">
    <span class="strat-icon">ğŸš€</span>
    <span class="strat-name">Breakout</span>
    <div class="strat-desc">EMA Â· ATR Â· Confidence</div>
  </div>
</div>

<!-- â•â• WAVETREND SECTION â•â• -->
<div class="tf-wrap active" id="wrap-wt">
  <!-- TF Tabs -->
  <div class="tf-tabs">
    <div class="tf-tab t15" id="tab-15m" onclick="setTF('15m')">
      <span class="tf-badge" id="badge-15m">0</span>15M
    </div>
    <div class="tf-tab t1h active" id="tab-1h" onclick="setTF('1h')">
      <span class="tf-badge" id="badge-1h">0</span>1H
    </div>
    <div class="tf-tab t4h" id="tab-4h" onclick="setTF('4h')">
      <span class="tf-badge" id="badge-4h">0</span>4H
    </div>
  </div>

  <!-- Stats WT -->
  <div class="stats" id="stats-wt">
    <div class="sc g"><div class="sn" id="wt-buy">0</div><div class="sl">Ø´Ø±Ø§Ø¡</div></div>
    <div class="sc r"><div class="sn" id="wt-sell">0</div><div class="sl">Ø¨ÙŠØ¹</div></div>
    <div class="sc y"><div class="sn" id="wt-vol">0</div><div class="sl">ÙÙˆÙ„ÙŠÙˆÙ…âœ“</div></div>
    <div class="sc b"><div class="sn" id="wt-sym">0</div><div class="sl">Ø±Ù…ÙˆØ²</div></div>
  </div>

  <!-- Filters WT -->
  <div class="filters" id="filters-wt">
    <button class="f on" onclick="setF(this,'all')">Ø§Ù„ÙƒÙ„</button>
    <button class="f" onclick="setF(this,'buy')">ğŸ“ˆ Ø´Ø±Ø§Ø¡</button>
    <button class="f" onclick="setF(this,'sell')">ğŸ“‰ Ø¨ÙŠØ¹</button>
    <button class="f" onclick="setF(this,'vol')">âš¡ ÙÙˆÙ„ÙŠÙˆÙ… Ù…Ø¤ÙƒØ¯</button>
    <button class="f" onclick="setF(this,'rsi')">RSI Ù…Ø¤ÙƒØ¯</button>
    <button class="f" onclick="setF(this,'strong')">ğŸ”¥ Ø¥Ø´Ø§Ø±Ø§Øª Ù‚ÙˆÙŠØ©</button>
  </div>
</div>

<!-- â•â• BREAKOUT SECTION â•â• -->
<div class="tf-wrap" id="wrap-bo">
  <!-- Stats BO -->
  <div class="stats">
    <div class="sc g"><div class="sn" id="bo-buy">0</div><div class="sl">CALL</div></div>
    <div class="sc r"><div class="sn" id="bo-sell">0</div><div class="sl">PUT</div></div>
    <div class="sc o"><div class="sn" id="bo-conf">0</div><div class="sl">Ø«Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©</div></div>
    <div class="sc b"><div class="sn" id="bo-sym">0</div><div class="sl">Ø±Ù…ÙˆØ²</div></div>
  </div>
  <!-- Filters BO -->
  <div class="filters">
    <button class="f on" onclick="setBOF(this,'all')">Ø§Ù„ÙƒÙ„</button>
    <button class="f" onclick="setBOF(this,'buy')">ğŸ“ˆ CALL</button>
    <button class="f" onclick="setBOF(this,'sell')">ğŸ“‰ PUT</button>
    <button class="f" onclick="setBOF(this,'highconf')">ğŸ”¥ Ø«Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©</button>
    <button class="f" onclick="setBOF(this,'vol')">âš¡ ÙÙˆÙ„ÙŠÙˆÙ…</button>
  </div>
</div>

<!-- CARDS -->
<div class="cards" id="cards"></div>

<!-- BOTTOM -->
<div class="bot">
  <input class="search" id="srch" placeholder="Ø§Ø¨Ø­Ø«... AAPL, NVDA"
    oninput="onSrch(this.value)" autocomplete="off" autocapitalize="characters" autocorrect="off">
  <div class="icon-btn" id="rfBtn" onclick="manualRefresh()">âŸ³</div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let data = {
  wt: { "15m":{signals:[]}, "1h":{signals:[]}, "4h":{signals:[]} },
  breakout: { signals:[] }
};
let strat   = 'wt';   // 'wt' | 'bo'
let curTF   = '1h';
let wtFilt  = 'all';
let boFilt  = 'all';
let srch    = '';
const REFRESH = 5 * 60 * 1000;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STRATEGY SWITCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStrat(s) {
  strat = s;
  document.getElementById('stab-wt').classList.toggle('active', s==='wt');
  document.getElementById('stab-bo').classList.toggle('active', s==='bo');
  document.getElementById('wrap-wt').classList.toggle('active', s==='wt');
  document.getElementById('wrap-bo').classList.toggle('active', s==='bo');
  renderCards();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TIMEFRAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTF(tf) {
  curTF = tf;
  ['15m','1h','4h'].forEach(t => {
    const el = document.getElementById('tab-'+t);
    el.classList.remove('active');
    if(t===tf) el.classList.add('active');
  });
  renderStats();
  renderCards();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FETCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchData() {
  try {
    const res = await fetch('/api/signals',{cache:'no-store'});
    const d   = await res.json();

    document.getElementById('scanWrap').classList.toggle('on', d.status==='initializing');
    if(d.updatedAt) {
      document.getElementById('ibUpdate').textContent =
        new Date(d.updatedAt).toLocaleTimeString('ar-SA',{timeZone:'Asia/Riyadh',hour:'2-digit',minute:'2-digit'});
    }

    data = {
      wt:       d.wt       || { "15m":{signals:[]}, "1h":{signals:[]}, "4h":{signals:[]} },
      breakout: d.breakout || { signals:[] },
    };

    ['15m','1h','4h'].forEach(tf => {
      document.getElementById('badge-'+tf).textContent = data.wt[tf].signals.length;
    });

    renderStats();
    renderCards();
  } catch(e) {
    document.getElementById('ibUpdate').textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
  }
}

function manualRefresh() {
  const b = document.getElementById('rfBtn');
  b.classList.add('spinning');
  fetchData().finally(()=>b.classList.remove('spinning'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MARKET STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateMarket() {
  const el  = document.getElementById('mktState');
  const now = new Date();
  const ny  = new Date(now.toLocaleString('en-US',{timeZone:'America/New_York'}));
  const mins = ny.getHours()*60+ny.getMinutes(), day=ny.getDay();
  const wd = day>=1&&day<=5;
  if(wd&&mins>=570&&mins<960)     { el.textContent='â— OPEN';   el.className='mkt open';   }
  else if(wd&&mins>=240&&mins<570){ el.textContent='â—‘ PRE';    el.className='mkt';        }
  else                            { el.textContent='â—‹ CLOSED'; el.className='mkt closed'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStats() {
  // WT stats
  const wt   = data.wt[curTF].signals;
  const buy  = wt.filter(s=>s.type==='buy').length;
  const sell = wt.filter(s=>s.type==='sell').length;
  const vol  = wt.filter(s=>s.volConf).length;
  const syms = new Set(wt.map(s=>s.symbol)).size;
  anim('wt-buy',buy); anim('wt-sell',sell); anim('wt-vol',vol); anim('wt-sym',syms);

  // Breakout stats
  const bo    = data.breakout.signals;
  const bBuy  = bo.filter(s=>s.type==='buy').length;
  const bSell = bo.filter(s=>s.type==='sell').length;
  const bHigh = bo.filter(s=>s.confidence>=80).length;
  const bSym  = new Set(bo.map(s=>s.symbol)).size;
  anim('bo-buy',bBuy); anim('bo-sell',bSell); anim('bo-conf',bHigh); anim('bo-sym',bSym);
}

function anim(id,target) {
  const el=document.getElementById(id); let cur=parseInt(el.textContent)||0;
  if(cur===target) return;
  const step=target>cur?1:-1;
  const t=setInterval(()=>{cur+=step;el.textContent=cur;if(cur===target)clearInterval(t);},40);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setF(btn, f) {
  wtFilt = f;
  document.querySelectorAll('#filters-wt .f').forEach(b=>b.classList.remove('on','on-buy','on-sell'));
  btn.classList.add('on');
  if(f==='buy')  btn.classList.add('on-buy');
  if(f==='sell') btn.classList.add('on-sell');
  renderCards();
}

function setBOF(btn, f) {
  boFilt = f;
  document.querySelectorAll('#wrap-bo .f').forEach(b=>b.classList.remove('on','on-buy','on-sell'));
  btn.classList.add('on');
  if(f==='buy')  btn.classList.add('on-buy');
  if(f==='sell') btn.classList.add('on-sell');
  renderCards();
}

function onSrch(v) { srch=v.trim(); renderCards(); }
function fmtV(v) { if(!v) return 'â€”'; if(v>=1e6) return (v/1e6).toFixed(1)+'M'; if(v>=1e3) return (v/1e3).toFixed(0)+'K'; return v; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER CARDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCards() {
  if (strat === 'wt') renderWT();
  else                renderBO();
}

// â”€â”€ WaveTrend cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderWT() {
  let sigs = [...data.wt[curTF].signals];
  if(wtFilt==='buy')    sigs=sigs.filter(s=>s.type==='buy');
  if(wtFilt==='sell')   sigs=sigs.filter(s=>s.type==='sell');
  if(wtFilt==='vol')    sigs=sigs.filter(s=>s.volConf);
  if(wtFilt==='rsi')    sigs=sigs.filter(s=>s.rsiSignal);
  if(wtFilt==='strong') sigs=sigs.filter(s=>s.volConf&&s.rsiSignal);
  if(srch){ const q=srch.toUpperCase(); sigs=sigs.filter(s=>s.symbol.includes(q)); }

  const wrap = document.getElementById('cards');
  if(!sigs.length) { wrap.innerHTML=emptyHTML(data.wt[curTF].signals.length); return; }

  const now = Date.now()/1000;
  wrap.innerHTML = sigs.map((s,i)=>{
    const buy  = s.type==='buy';
    const isNew= i<5&&(now-s.timestamp/1000)<3600;
    const rsiC = !s.rsi?'var(--muted)':s.rsi<30?'var(--buy)':s.rsi>70?'var(--sell)':'var(--blue)';
    return `
    <div class="card ${s.type}" style="animation-delay:${Math.min(i*25,300)}ms">
      <div class="ch">
        <div class="ch-left">
          <div class="arr">${buy?'â–²':'â–¼'}</div>
          <div>
            <div class="sym-row">
              <span class="sym">${s.symbol}</span>
              ${isNew?'<span class="new-tag">NEW</span>':''}
            </div>
            <div class="ch-date">â± ${s.date}</div>
          </div>
        </div>
        <div class="ch-right">
          <div class="ch-price">$${s.close.toFixed(2)}</div>
          <div class="ch-lbl">CLOSE</div>
        </div>
      </div>
      <div class="pills">
        <span class="p ${buy?'p-gb':'p-gs'}">${buy?'â–² BUY':'â–¼ SELL'}</span>
        ${s.volConf?'<span class="p p-gr">âš¡ VOL âœ“</span>':'<span class="p p-gy">VOL âœ—</span>'}
        ${s.highVol?'<span class="p p-go">ğŸ”¥ HIGH VOL</span>':''}
        ${s.rsiSignal?'<span class="p p-gp">RSI âœ“</span>':''}
        ${s.rsi!=null?`<span class="p p-gy"><span class="rsi-m"><span style="color:${rsiC};min-width:28px">RSI ${s.rsi}</span><span class="rsi-t"><span class="rsi-f" style="width:${Math.min(100,s.rsi)}%;background:${rsiC}"></span></span></span></span>`:''}
      </div>
      <div class="cf">
        <div class="cf-i"><div class="cf-v" style="color:var(--blue)">${fmtV(s.volume)}</div><div class="cf-l">ÙÙˆÙ„ÙŠÙˆÙ…</div></div>
        <div class="cf-i"><div class="cf-v" style="color:var(--muted)">${fmtV(s.avgVol)}</div><div class="cf-l">Ù…ØªÙˆØ³Ø· 5</div></div>
        <div class="cf-i"><div class="cf-v" style="color:${s.highVol?'var(--gold)':'var(--muted)'}">${s.highVol?'Ø¹Ø§Ù„Ùâœ“':'Ø¹Ø§Ø¯ÙŠ'}</div><div class="cf-l">Ø­Ø¬Ù…</div></div>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ Breakout cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBO() {
  let sigs = [...data.breakout.signals];
  if(boFilt==='buy')      sigs=sigs.filter(s=>s.type==='buy');
  if(boFilt==='sell')     sigs=sigs.filter(s=>s.type==='sell');
  if(boFilt==='highconf') sigs=sigs.filter(s=>s.confidence>=80);
  if(boFilt==='vol')      sigs=sigs.filter(s=>s.highVol);
  if(srch){ const q=srch.toUpperCase(); sigs=sigs.filter(s=>s.symbol.includes(q)); }

  const wrap = document.getElementById('cards');
  if(!sigs.length) { wrap.innerHTML=emptyHTML(data.breakout.signals.length); return; }

  wrap.innerHTML = sigs.map((s,i)=>{
    const buy  = s.type==='buy';
    const conf = s.confidence||0;
    const r    = 22, circ = 2*Math.PI*r;
    const dash = circ*(conf/100);
    const confColor = conf>=80?'var(--buy)':conf>=60?'var(--gold)':'var(--orange)';
    const rsiC = !s.rsi?'var(--muted)':s.rsi>60?'var(--buy)':s.rsi<40?'var(--sell)':'var(--blue)';
    return `
    <div class="bo-card ${s.type}" style="animation-delay:${Math.min(i*25,300)}ms">
      <div class="bo-head">
        <div class="bo-left">
          <div class="bo-icon">${buy?'ğŸš€':'ğŸ“‰'}</div>
          <div>
            <div class="bo-sym">${s.symbol}</div>
            <div class="bo-type">${buy?'â–² CALL â€” Breakout Up':'â–¼ PUT â€” Breakout Down'}</div>
            <div class="bo-type" style="margin-top:2px">â± ${s.date}</div>
          </div>
        </div>
        <div class="bo-right">
          <div class="conf-ring">
            <svg width="52" height="52" viewBox="0 0 52 52">
              <circle cx="26" cy="26" r="${r}" fill="none" stroke="var(--s3)" stroke-width="4"/>
              <circle cx="26" cy="26" r="${r}" fill="none" stroke="${confColor}" stroke-width="4"
                stroke-dasharray="${dash} ${circ}" stroke-linecap="round"/>
            </svg>
            <div class="conf-val" style="color:${confColor}">${conf}%</div>
          </div>
          <div style="text-align:center;font-size:8px;color:var(--muted);margin-top:2px;font-family:var(--mono)">CONF</div>
        </div>
      </div>

      <div class="bo-levels">
        <div class="bo-lv"><div class="bo-lv-val entry-v">$${s.close}</div><div class="bo-lv-lbl">Entry</div></div>
        <div class="bo-lv"><div class="bo-lv-val tp-v">$${s.tp}</div><div class="bo-lv-lbl">TP +3Ã—ATR</div></div>
        <div class="bo-lv"><div class="bo-lv-val sl-v">$${s.sl}</div><div class="bo-lv-lbl">SL -1.5Ã—ATR</div></div>
      </div>

      <div class="bo-ema">
        <div class="bo-ema-i"><div class="bo-ema-v">$${s.ema20}</div><div class="bo-ema-l">EMA 20</div></div>
        <div class="bo-ema-i"><div class="bo-ema-v">$${s.ema50}</div><div class="bo-ema-l">EMA 50</div></div>
        <div class="bo-ema-i"><div class="bo-ema-v">$${s.ema200}</div><div class="bo-ema-l">EMA 200</div></div>
      </div>

      <div class="bo-tags">
        <span class="p ${buy?'p-gb':'p-gs'}">${buy?'â–² CALL':'â–¼ PUT'}</span>
        ${s.highVol?'<span class="p p-go">ğŸ”¥ HIGH VOL</span>':''}
        ${conf>=80?'<span class="p p-gr">âœ“ HIGH CONF</span>':''}
        ${s.rsi!=null?`<span class="p p-gy" style="color:${rsiC}">RSI ${s.rsi}</span>`:''}
        <span class="p p-gy">ATR $${s.atr}</span>
      </div>
    </div>`;
  }).join('');
}

function emptyHTML(total) {
  return `<div class="empty">
    <div class="e-icon">${total?'ğŸ”':'ğŸ›°ï¸'}</div>
    <div class="e-title">${total?'Ù„Ø§ Ù†ØªØ§Ø¦Ø¬ Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙÙ„ØªØ±':'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø§Ø±Ø§Øª'}</div>
    <div class="e-sub">${total?'Ø¬Ø±Ù‘Ø¨ ÙÙ„ØªØ±Ø§Ù‹ Ø¢Ø®Ø±':'Ù„Ù… ØªÙÙƒØªØ´Ù Ø¥Ø´Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹'}</div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastT;
function toast(msg){ const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show'); clearTimeout(toastT); toastT=setTimeout(()=>el.classList.remove('show'),3200); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded',()=>{
  updateMarket();
  setInterval(updateMarket, 30000);
  setTF('1h');
  fetchData();
  setInterval(fetchData, REFRESH);
  document.addEventListener('visibilitychange',()=>{ if(!document.hidden) fetchData(); });
});
</script>
</body>
</html>
